# Excel Format Documentation - Vessel Recommendations Report

This document specifies the exact format, structure, and styling for the vessel recommendations Excel file generated by the system.

## File Naming Convention

**Format:** `Recommendations_{VESSEL_NAME}_{YYYYMMDD}.xlsx`

**Rules:**
- Vessel name: Uppercase, spaces replaced with underscores
- Date: YYYYMMDD format (e.g., 20240115)
- Extension: `.xlsx`

**Examples:**
- `Recommendations_GCL_YAMUNA_20240115.xlsx`
- `Recommendations_MSC_OSCAR_20240120.xlsx`
- `Recommendations_UNKNOWN_VESSEL_20240115.xlsx` (if name not available)

---

## Sheet Structure

The Excel workbook contains **4 sheets** in the following order:

1. **Summary** - Vessel overview and statistics
2. **CRITICAL** - Critical priority recommendations
3. **MODERATE** - Moderate priority recommendations
4. **RECOMMENDED** - Recommended priority items

---

## Sheet 1: Summary

### Layout

| Row | Column A | Column B |
|-----|----------|----------|
| 1 | Vessel Name | {vessel.name} |
| 2 | IMO | {vessel.imo} |
| 3 | Risk Score | {vessel.riskScore} |
| 4 | Risk Level | {vessel.riskLevel} |
| 5 | *(empty)* | *(empty)* |
| 6 | Last Inspection Date | {vessel.lastInspection.date} |
| 7 | Last Inspection Port | {vessel.lastInspection.port} |
| 8 | *(empty)* | *(empty)* |
| 9 | **Recommendations Summary** | *(empty)* |
| 10 | Critical | {critical_count} |
| 11 | Moderate | {moderate_count} |
| 12 | Recommended | {recommended_count} |
| 13 | Total | {total_count} |

### Column Specifications

- **Column A (Label)**: Width = 25 characters
  - Font: Arial, 11pt, Regular
  - Alignment: Left, Middle
  
- **Column B (Value)**: Width = 30 characters
  - Font: Arial, 11pt, Regular
  - Alignment: Left, Middle

### Styling Rules

1. **Row 9 (Header Row)**:
   - Background Color: `#1F4E78` (Dark Blue)
   - Font: Arial, 11pt, **Bold**, White (`#FFFFFF`)
   - Alignment: Left, Middle
   - Border: None

2. **Rows 1-8, 10-13 (Data Rows)**:
   - Background Color: White (`#FFFFFF`)
   - Font: Arial, 11pt, Regular, Black
   - Alignment: Left, Middle
   - Border: None

3. **Row 3 (Risk Score)**:
   - Font: Arial, 11pt, **Bold**, Black
   - Number Format: General (or 0.0 if decimal)

4. **Row 10-12 (Count Rows)**:
   - Font: Arial, 11pt, Regular, Black
   - Number Format: General

---

## Sheet 2: CRITICAL

### Column Structure

| Column | Header | Key | Width | Data Type |
|--------|--------|-----|-------|-----------|
| A | Category | `category` | 20 | Text |
| B | Issue Type | `issueType` | 25 | Text |
| C | Campaign Trend | `campaignTrend` | 20 | Text |
| D | General Recommendations | `generalRecommendations` | 40 | Text |
| E | Internal Checklist | `internalChecklist` | 40 | Text |
| F | External Checklist | `externalChecklist` | 40 | Text |

### Data Mapping

Each row represents one critical recommendation:

```javascript
{
  category: rec.category || rec.type || 'General',
  issueType: rec.issueType || rec.issue_type || '',
  campaignTrend: rec.campaignTrend || rec.campaign_trend || rec.trend || '',
  generalRecommendations: rec.generalRecommendations || rec.general_recommendations || rec.description || rec.recommendation || rec.text || '',
  internalChecklist: rec.internalChecklist || rec.internal_checklist || '',
  externalChecklist: rec.externalChecklist || rec.external_checklist || ''
}
```

### Styling Rules

1. **Header Row (Row 1)**:
   - Background Color: `#1F4E78` (Dark Blue)
   - Font: Arial, 11pt, **Bold**, White (`#FFFFFF`)
   - Alignment: Center, Middle
   - Border: None
   - Text Wrap: Enabled

2. **Data Rows (Row 2+)**:
   - Background Color: `#FFE6E6` (Light Red)
   - Font: Arial, 10pt, Regular, Black
   - Alignment: Top, Left
   - Text Wrap: Enabled
   - Border: None

3. **Column Widths**:
   - Auto-adjusted based on content
   - Minimum: 10 characters
   - Maximum: 50 characters
   - Default widths as specified above

4. **Filters**:
   - Enabled on all columns
   - Auto-filter range: Row 1 to last data row

5. **Frozen Panes**:
   - Header row (Row 1) is frozen
   - Users can scroll data while keeping headers visible

---

## Sheet 3: MODERATE

### Column Structure

Same as CRITICAL sheet (6 columns with identical headers and structure).

### Data Mapping

Same as CRITICAL sheet, but filtered for moderate priority items.

### Styling Rules

1. **Header Row (Row 1)**:
   - Same as CRITICAL sheet (Dark Blue background, White text)

2. **Data Rows (Row 2+)**:
   - Background Color: `#FFFFE6` (Light Yellow)
   - All other styling same as CRITICAL sheet

3. **Column Widths, Filters, Frozen Panes**:
   - Same as CRITICAL sheet

---

## Sheet 4: RECOMMENDED

### Column Structure

Same as CRITICAL and MODERATE sheets (6 columns with identical headers and structure).

### Data Mapping

Same as CRITICAL sheet, but filtered for recommended/low priority items.

### Styling Rules

1. **Header Row (Row 1)**:
   - Same as CRITICAL sheet (Dark Blue background, White text)

2. **Data Rows (Row 2+)**:
   - Background Color: `#E6FFE6` (Light Green)
   - All other styling same as CRITICAL sheet

3. **Column Widths, Filters, Frozen Panes**:
   - Same as CRITICAL sheet

---

## Color Palette

| Purpose | Hex Code | RGB | Usage |
|---------|----------|-----|-------|
| Header Background | `#1F4E78` | RGB(31, 78, 120) | All sheet headers |
| Header Text | `#FFFFFF` | RGB(255, 255, 255) | All header text |
| Critical Background | `#FFE6E6` | RGB(255, 230, 230) | CRITICAL sheet data rows |
| Moderate Background | `#FFFFE6` | RGB(255, 255, 230) | MODERATE sheet data rows |
| Recommended Background | `#E6FFE6` | RGB(230, 255, 230) | RECOMMENDED sheet data rows |
| Text Color | `#000000` | RGB(0, 0, 0) | All data text |

---

## Data Mapping from API Response

### Sample API Response Structure

```json
{
  "vessel": {
    "name": "GCL YAMUNA",
    "imo": "9481219",
    "riskScore": 45,
    "riskLevel": "HIGH",
    "lastInspection": {
      "date": "2024-01-15",
      "port": "Port of Singapore"
    }
  },
  "recommendations": [
    {
      "category": "Covers (hatchway-, portable-, tarpaulins, etc.)",
      "issueType": "CRITICAL",
      "priority": "CRITICAL",
      "severity": "HIGH",
      "campaignTrend": "Increasing trend in PSC inspections",
      "campaigns": {
        "trend": "Increasing trend in PSC inspections",
        "recommendations": [
          "Ensure all covers are properly secured",
          "Inspect covers for damage before departure"
        ]
      },
      "generalRecommendations": [
        "Inspect all hatchway covers for proper fit",
        "Check tarpaulin condition and replace if damaged",
        "Ensure proper securing mechanisms are functional"
      ],
      "internalChecklist": [
        "Visual inspection of all covers",
        "Documentation of cover condition",
        "Maintenance schedule review"
      ],
      "externalChecklist": [
        "PSC inspection readiness",
        "Compliance with SOLAS requirements",
        "Port state control preparation"
      ],
      "description": "Hatchway covers require immediate attention",
      "recommendation": "Replace damaged covers and ensure proper securing",
      "text": "Critical issue with hatchway covers",
      "status": "Pending",
      "dueDate": "2024-02-15"
    },
    {
      "category": "Fire safety",
      "issueType": "MODERATE",
      "priority": "MODERATE",
      "severity": "MEDIUM",
      "campaignTrend": "Standard compliance check",
      "generalRecommendations": [
        "Review fire safety equipment maintenance records"
      ],
      "internalChecklist": [
        "Fire extinguisher inspection",
        "Fire detection system test"
      ],
      "externalChecklist": [
        "SOLAS compliance verification"
      ]
    },
    {
      "category": "Navigation equipment",
      "issueType": "RECOMMENDED",
      "priority": "RECOMMENDED",
      "severity": "LOW",
      "campaignTrend": "Best practice recommendation",
      "generalRecommendations": [
        "Consider upgrading navigation equipment"
      ],
      "internalChecklist": [
        "Equipment performance review"
      ],
      "externalChecklist": [
        "Industry best practices compliance"
      ]
    }
  ]
}
```

### Mapping Logic

#### Summary Sheet Mapping

```javascript
// Row 1: Vessel Name
cellValue = vessel.name || 'Unknown Vessel'

// Row 2: IMO
cellValue = vessel.imo || 'N/A'

// Row 3: Risk Score
cellValue = vessel.riskScore || vessel.risk_score || 'N/A'

// Row 4: Risk Level
cellValue = vessel.riskLevel || vessel.risk_level || 'N/A'

// Row 6: Last Inspection Date
cellValue = vessel.lastInspection?.date || 
            vessel.lastInspection?.inspectionDate || 
            vessel.last_inspection?.date || 
            'N/A'

// Row 7: Last Inspection Port
cellValue = vessel.lastInspection?.port || 
            vessel.lastInspection?.portName || 
            vessel.last_inspection?.port || 
            'N/A'

// Row 10: Critical Count
cellValue = recommendations.filter(r => 
  (r.priority || r.severity || '').toUpperCase() === 'CRITICAL' || 
  (r.priority || r.severity || '').toUpperCase() === 'HIGH'
).length

// Row 11: Moderate Count
cellValue = recommendations.filter(r => 
  (r.priority || r.severity || '').toUpperCase() === 'MODERATE' || 
  (r.priority || r.severity || '').toUpperCase() === 'MEDIUM'
).length

// Row 12: Recommended Count
cellValue = recommendations.filter(r => 
  (r.priority || r.severity || '').toUpperCase() === 'RECOMMENDED' || 
  (r.priority || r.severity || '').toUpperCase() === 'LOW' ||
  (!critical.includes(r) && !moderate.includes(r))
).length

// Row 13: Total Count
cellValue = recommendations.length
```

#### Priority Sheet Mapping (CRITICAL, MODERATE, RECOMMENDED)

For each recommendation row:

```javascript
// Column A: Category
cellValue = rec.category || rec.type || 'General'

// Column B: Issue Type
cellValue = rec.issueType || rec.issue_type || ''

// Column C: Campaign Trend
cellValue = rec.campaignTrend || 
            rec.campaign_trend || 
            rec.campaigns?.trend || 
            rec.trend || 
            ''

// Column D: General Recommendations
// If array, join with newlines; if string, use as-is
cellValue = Array.isArray(rec.generalRecommendations) 
  ? rec.generalRecommendations.join('\n')
  : (rec.general_recommendations 
      ? (Array.isArray(rec.general_recommendations) 
          ? rec.general_recommendations.join('\n')
          : rec.general_recommendations)
      : (rec.description || rec.recommendation || rec.text || ''))

// Column E: Internal Checklist
cellValue = Array.isArray(rec.internalChecklist)
  ? rec.internalChecklist.join('\n')
  : (rec.internal_checklist
      ? (Array.isArray(rec.internal_checklist)
          ? rec.internal_checklist.join('\n')
          : rec.internal_checklist)
      : '')

// Column F: External Checklist
cellValue = Array.isArray(rec.externalChecklist)
  ? rec.externalChecklist.join('\n')
  : (rec.external_checklist
      ? (Array.isArray(rec.external_checklist)
          ? rec.external_checklist.join('\n')
          : rec.external_checklist)
      : '')
```

---

## Formulas

Currently, **no formulas** are used in the Excel file. All values are static data from the API response.

**Future Considerations:**
- Summary sheet could include formulas for:
  - Percentage calculations (e.g., `=B10/B13` for critical percentage)
  - Risk score trends (if historical data available)
  - Date calculations (days since last inspection)

---

## ASCII Representation

### Summary Sheet

```
┌─────────────────────────┬──────────────────────────────┐
│ Vessel Name             │ GCL YAMUNA                  │
│ IMO                     │ 9481219                     │
│ Risk Score              │ 45                          │
│ Risk Level              │ HIGH                        │
│                         │                              │
│ Last Inspection Date    │ 2024-01-15                  │
│ Last Inspection Port    │ Port of Singapore           │
│                         │                              │
│ Recommendations Summary │                              │
│ Critical                │ 5                            │
│ Moderate                │ 4                            │
│ Recommended             │ 3                            │
│ Total                   │ 12                           │
└─────────────────────────┴──────────────────────────────┘
```

### CRITICAL Sheet (Sample)

```
┌──────────────────────┬─────────────────────────┬──────────────────────┬──────────────────────────────────────┬──────────────────────────────────────┬──────────────────────────────────────┐
│ Category             │ Issue Type              │ Campaign Trend       │ General Recommendations             │ Internal Checklist                   │ External Checklist                  │
├──────────────────────┼─────────────────────────┼──────────────────────┼──────────────────────────────────────┼──────────────────────────────────────┼──────────────────────────────────────┤
│ Covers (hatchway-...)│ CRITICAL                │ Increasing trend...  │ Inspect all hatchway covers...      │ Visual inspection of all covers      │ PSC inspection readiness             │
│                      │                         │                      │ Check tarpaulin condition...        │ Documentation of cover condition     │ Compliance with SOLAS requirements   │
│                      │                         │                      │ Ensure proper securing...           │ Maintenance schedule review          │ Port state control preparation       │
├──────────────────────┼─────────────────────────┼──────────────────────┼──────────────────────────────────────┼──────────────────────────────────────┼──────────────────────────────────────┤
│ Fire safety          │ CRITICAL                │ Standard compliance  │ Review fire safety equipment...      │ Fire extinguisher inspection         │ SOLAS compliance verification       │
│                      │                         │                      │                                      │ Fire detection system test           │                                      │
└──────────────────────┴─────────────────────────┴──────────────────────┴──────────────────────────────────────┴──────────────────────────────────────┴──────────────────────────────────────┘
```

*Note: Background colors are not shown in ASCII - refer to Color Palette section*

---

## Implementation Notes

### Excel Generation Process

1. **Create Workbook**: Initialize ExcelJS workbook
2. **Create Sheets**: Add 4 sheets in order (Summary, CRITICAL, MODERATE, RECOMMENDED)
3. **Populate Summary Sheet**: Add vessel data and counts
4. **Group Recommendations**: Filter by priority (CRITICAL, MODERATE, RECOMMENDED)
5. **Populate Priority Sheets**: Add filtered recommendations with proper column mapping
6. **Apply Styling**: 
   - Set header row styles (dark blue background, white text)
   - Set data row background colors based on priority
   - Enable text wrapping
   - Set column widths
7. **Add Features**:
   - Enable auto-filters
   - Freeze header rows
8. **Generate File**: Write to buffer and save

### Data Handling

- **Empty Values**: Use empty string `''` or `'N/A'` for missing data
- **Array Values**: Join arrays with newline character `\n` for multi-line cells
- **Date Formatting**: Use ISO format (YYYY-MM-DD) or display format as received
- **Text Length**: No hard limit, but wrap text for readability
- **Special Characters**: Preserve as-is (Excel handles encoding)

### Error Handling

- If vessel data is missing: Use 'Unknown Vessel' or 'N/A'
- If recommendations array is empty: Create empty sheets with headers only
- If specific recommendation field is missing: Use empty string or fallback value
- If priority cannot be determined: Default to RECOMMENDED sheet

---

## Testing Checklist

- [ ] Summary sheet displays all vessel information correctly
- [ ] Counts match actual recommendation counts
- [ ] CRITICAL sheet only contains critical/high priority items
- [ ] MODERATE sheet only contains moderate/medium priority items
- [ ] RECOMMENDED sheet contains remaining items
- [ ] Header rows have correct styling (dark blue, white text)
- [ ] Data rows have correct background colors
- [ ] Column widths are appropriate
- [ ] Text wrapping works for long content
- [ ] Filters are enabled and functional
- [ ] Header rows are frozen
- [ ] File name follows convention
- [ ] Arrays are properly joined with newlines
- [ ] Missing data shows 'N/A' or empty string appropriately

---

## Version History

- **v1.0.0** (2024-01-15): Initial specification
  - 4-sheet structure
  - Color-coded priority sheets
  - Standardized column structure
  - File naming convention

---

## References

- ExcelJS Documentation: https://github.com/exceljs/exceljs
- Excel Color Codes: https://www.rapidtables.com/web/color/RGB_Color.html
- SOLAS Requirements: International Convention for the Safety of Life at Sea


